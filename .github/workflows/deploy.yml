# í”„ë¡œë•ì…˜ ë°°í¬ìš© ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Deploy to AWS ECS - discodeit

# íŠ¸ë¦¬ê±° ì¡°ê±´: release ë¸Œëœì¹˜ì— í‘¸ì‰¬ ì‹œ ìë™ ì‹¤í–‰
on:
  push:
    branches: [release]

# ì‘ì—… ëª©ë¡ ì •ì˜
jobs:
  build-and-push:
    # Job ì´ë¦„ (UIì— í‘œì‹œ)
    name: Build and Push Docker Image
    # GitHub Actionsê°€ ì‚¬ìš©í•˜ëŠ” ê°€ìƒ ë¨¸ì‹  í™˜ê²½
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. Java 17 í™˜ê²½ ì„¤ì • (Spring Boot í”„ë¡œì íŠ¸ ë¹Œë“œìš©)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. AWS ìê²© ì¦ëª… êµ¬ì„± (AWS CLI)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1 # Public ECRì€ ë°˜ë“œì‹œ us-east-1 ë¦¬ì „ ì‚¬ìš©

      # 4. Public ECRì— ë¡œê·¸ì¸
      - name: Login to Amazon Public ECR
        run: aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and Push Docker Image to Public ECR
        env:
          ECR_REGISTRY: ${{ vars.ECR_REPOSITORY_URI }} # ex) public.ecr.aws/abc123/discodeit
          IMAGE_TAG: ${{ github.sha }} # ì»¤ë°‹ í•´ì‹œ ê¸°ë°˜ íƒœê·¸
        run: |
          # 1. ëª…ë ¹ì–´ ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ
          set -e
          
          # 2. í˜„ì¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì™€ íƒœê·¸ í™•ì¸ ë¡œê·¸
          echo "ECR_REGISTRY = $ECR_REGISTRY"
          echo "IMAGE_TAG = $IMAGE_TAG"
          
          # 3. gradlew ë¹Œë“œ ê¶Œí•œ ë¶€ì—¬ ë° JAR ìƒì„±
            # gradlew íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x ./gradlew
          echo "Building Spring Boot app..."
            # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (JAR ìƒì„±)
          ./gradlew bootJar

          # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë‘ ê°œì˜ íƒœê·¸: í•´ì‹œ + latest)
          echo "Building Docker image..."
          docker build -t $ECR_REGISTRY:$IMAGE_TAG -t $ECR_REGISTRY:latest .

          # Public ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
          echo "Pushing Docker image to ECR..."
          # ECRì— ì´ë¯¸ì§€ í‘¸ì‰¬ (ì»¤ë°‹ í•´ì‹œ íƒœê·¸) - ì‹¤ì œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          # ECRì— ì´ë¯¸ì§€ í‘¸ì‰¬ (latest íƒœê·¸) - íƒœê·¸ë§Œ ì¶”ê°€ë¡œ í‘¸ì‰¬ (ìš©ëŸ‰ ì¶”ê°€ ì—†ìŒ)
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë¹Œë“œëœ ì´ë¯¸ì§€ ì •ë³´ë¥¼ ì¶œë ¥
          # ì´ ë‹¨ê³„ì˜ ì¶œë ¥ê°’ì„ ë‹¤ë¥¸ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ID ì„¤ì • (GITHUB_OUTPUTê°€ ë³€ìˆ˜í™”ë¨)
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy:
    name: Update ECS Service
    runs-on: ubuntu-latest
    needs: build-and-push  # [ìš”êµ¬ì‚¬í•­] build í›„ ì‹¤í–‰ë˜ë„ë¡ ì—°ê²°

    steps:
      # 1. AWS ìê²© ì¦ëª… ì„¤ì • (AWS CLI)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}  # [ìš”êµ¬ì‚¬í•­] ECS í´ëŸ¬ìŠ¤í„° ì ‘ê·¼ì— í•„ìš”í•œ ë¦¬ì „ ì‚¬ìš©

      # 2. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ECS ì„œë¹„ìŠ¤ ì¤‘ë‹¨ (ìŠ¤ì¼€ì¼ 0)
      - name: Deregister previous ECS service (scale down to 0)
        run: |
          aws ecs update-service \
            --cluster ${{ vars.ECS_CLUSTER }} \
            --service ${{ vars.ECS_SERVICE }} \
            --desired-count 0  # [ìš”êµ¬ì‚¬í•­] í”„ë¦¬í‹°ì–´ ê³ ë ¤í•´ ì‹¤í–‰ ì¤‘ì§€
            --region ${{ vars.AWS_REGION }}

      # 3. ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡ (task-definition.json ê¸°ë°˜)
      - name: Register new task definition with updated image
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ vars.ECS_SERVICE }}
          cluster: ${{ vars.ECS_CLUSTER }}
          wait-for-service-stability: true

      # 4. ìƒˆ íƒœìŠ¤í¬ ì •ì˜ë¥¼ ì„œë¹„ìŠ¤ì— ë°˜ì˜í•˜ê³  ë‹¤ì‹œ ì‹¤í–‰
      - name: Update ECS service with new task definition
        run: |
          aws ecs update-service \
            --cluster ${{ vars.ECS_CLUSTER }} \
            --service ${{ vars.ECS_SERVICE }} \
            --desired-count 1  # ğŸ”¹ [ìš”êµ¬ì‚¬í•­] ì„œë¹„ìŠ¤ ì¬ì‹¤í–‰
            --region ${{ vars.AWS_REGION }}
